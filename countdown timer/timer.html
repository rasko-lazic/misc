<!DOCTYPE html>
<html>
<head>
	<title>Timer</title>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:100">
	<link rel="stylesheet" type="text/css" href="assets/css/bulma.min.css">
	<link rel="stylesheet" type="text/css" href="assets/css/timer.css">
</head>
<body>
	<section class="hero is-primary is-bold">
		<div class="hero-body">
			<div class="container has-text-centered">
				<h1 class="title">Simple countdown</h1>
			</div>
		</div>
	</section>

	<section class="section">
		<div class="container">
			<div class="level timer-container" id="timerContainer">
				<div class="level-item">
					<span class="counter major" id="majorHoursCounter" style="margin-left: 0;">0</span>
				</div>
				<div class="level-item">
					<span class="counter minor" id="minorHoursCounter">0</span>
					<span class="marker">h</span>
				</div>
				<div class="level-item">
					<span class="counter major" id="majorMinutesCounter">0</span>
				</div>
				<div class="level-item">
					<span class="counter minor" id="minorMinutesCounter">0</span>
					<span class="marker">m</span>
				</div>
				<div class="level-item">
					<span class="counter major" id="majorSecondsCounter">0</span>
				</div>
				<div class="level-item">
					<span class="counter minor" id="minorSecondsCounter">0</span>
					<span class="marker">s</span>
				</div>
			</div>

			<div class="level progress-container">
				<progress class="progress is-primary is-small" id="timerProgress" value="0" max="100" style="height: 0.2rem"></progress>
			</div>

			<div class="level button-container">
				<div class="level-item">
					<button class="button is-large" id="timerToggleButton">START</button>
				</div>
				<div class="level-item">
					<button class="button is-large" id="timerResetButton">RESET</button>
				</div>
				<input type="text" class="timer-input" id="timeInput" name="timer-input">
			</div>
		</div>
	</section>

	<script type="text/javascript">

		window.onload = function () {
			var timerContainer = document.getElementById('timerContainer');
			var timeInput = document.getElementById('timeInput');
			var counters = document.getElementsByClassName('counter');
			var markers = document.getElementsByClassName('marker');

			timerContainer.addEventListener('click', function () {
				Array.prototype.forEach.call(counters, function(counter) {
					counter.classList.add('unsure');
				});
				Array.prototype.forEach.call(markers, function(marker) {
					marker.classList.add('unsure');
				});
				counters[5].classList.add('pointer');

				timeInput.focus();
			});

			var parseCounters = function () {
				return ((parseInt(majorHoursCounter.innerHTML) * 10 + parseInt(minorHoursCounter.innerHTML)) * 3600
						+ (parseInt(majorMinutesCounter.innerHTML) * 10 + parseInt(minorMinutesCounter.innerHTML)) * 60
						+ (parseInt(majorSecondsCounter.innerHTML) * 10 + parseInt(minorSecondsCounter.innerHTML)) + 0.98) * 1000
			};


			timeInput.addEventListener('keydown', function (event) {
				var char = event.key;
				var charCode = event.which;

				if(charCode >= 48 && charCode <= 57) {
					for(var i = 0; i < 5; i ++) {
						counters[i].innerHTML = counters[i + 1].innerHTML;
					}
					counters[5].innerHTML = char;

					timerSecondsSet = parseCounters();
				}

				if(charCode === 8) {
					for(var i = 5; i > 0; i--) {
						counters[i].innerHTML = counters[i - 1].innerHTML;
					}
					counters[0].innerHTML = 0;

					timerSecondsSet = parseCounters();
				}
			});

			var minorSecondsCounter = document.getElementById('minorSecondsCounter');
			var majorSecondsCounter = document.getElementById('majorSecondsCounter');
			var minorMinutesCounter = document.getElementById('minorMinutesCounter');
			var majorMinutesCounter = document.getElementById('majorMinutesCounter');
			var minorHoursCounter = document.getElementById('minorHoursCounter');
			var majorHoursCounter = document.getElementById('majorHoursCounter');

			var started = false;
			var timerSecondsSet = 0;
			var timerSecondsElapsed = 0;
			var startButton = document.getElementById('timerToggleButton');
			var resetButton = document.getElementById('timerResetButton')
			var timerProgress = document.getElementById('timerProgress');

			startButton.addEventListener('click', startTimer);
			resetButton.addEventListener('click', resetTimer);

			var countdownInterval;

			function resetTimer() {
				clearInterval(countdownInterval);
				started = false;
				toggleStartButton();
				setCounters(timerSecondsSet / 1000);
				timerSecondsElapsed = 0;
				timerProgress.setAttribute("value", 0);
			}

			function startTimer () {
				if(timerSecondsSet > 0) {
					started = true;
					toggleStartButton();
					Array.prototype.forEach.call(counters, function(counter) {
						counter.classList.remove('unsure');
					});
					Array.prototype.forEach.call(markers, function(marker) {
						marker.classList.remove('unsure');
					});
					counters[5].classList.remove('pointer');
				    
					countdownInterval = setInterval(function () {
						timerSecondsElapsed += 20;
						percentagePassed = ((timerSecondsElapsed + 20) / (timerSecondsSet - 980)) * 100;
						timerProgress.setAttribute("value", percentagePassed);
						var timeRemaining = timerSecondsSet - timerSecondsElapsed;
						if(timeRemaining > 1000) {
							setCounters(timeRemaining / 1000);
						} else {
							setCounters(0);
							clearInterval(countdownInterval);
							started = false;
							timerSecondsElapsed = 0;
							toggleStartButton();
						}
					}, 20)
				}
			};

			function setCounters(seconds) {
				majorHoursCounter.innerHTML = Math.floor(seconds / 3600 / 10);
				minorHoursCounter.innerHTML = Math.floor(seconds / 3600 % 10);
				seconds = seconds % 3600;
				majorMinutesCounter.innerHTML = Math.floor(seconds / 60 / 10);
				minorMinutesCounter.innerHTML = Math.floor(seconds / 60 % 10);
				seconds = seconds % 60;
				majorSecondsCounter.innerHTML = Math.floor(seconds / 10);
				minorSecondsCounter.innerHTML = Math.floor(seconds % 10);
			};

			function toggleStartButton() {
				if(started) {
					startButton.removeEventListener('click', startTimer);
					startButton.innerHTML = 'STOP';
					startButton.addEventListener('click', pauseTimer);
				} else {
					startButton.removeEventListener('click', pauseTimer);
					startButton.innerHTML = 'START';
					startButton.addEventListener('click', startTimer);
				}
			}

			function pauseTimer() {
				started = false;
				toggleStartButton();
				clearInterval(countdownInterval);
			}
		}
	</script>
</body>
</html>